(()=>{const k=(E=1,D=10,r=200)=>new Promise(((n,x)=>{const L=(()=>{const k=sessionStorage.getItem("bis_data");return null!==k?JSON.parse(k):null})();return L?n(L):E>=D?x(new Error(`posd_log: ${(new Date).toLocaleString()} ERROR: (PosdChatgptMessagesCollector) config not found after ${D} attempts`)):void setTimeout((()=>{n(k(E+1,D,r))}),r)}));(async()=>{try{let E=null;const D=function(){window.addEventListener("message",(k=>{if("CHATGPT_PROTECTION_STATUS_RESPONSE"===k.data?.type)E=k.data.content})),window.postMessage({posdMessageId:"PANELOS_MESSAGE",posdHash:(Math.random().toString(36).substring(2,15)+Math.random().toString(36).substring(2,15)+Math.random().toString(36).substring(2,15)).substring(0,22),type:"CHATGPT_PROTECTION_STATUS",from:n,to:n.substring(0,n.length-2),appId:L,content:""})},r=await k(),n=r?.config?`${r.id}_t`:null,x=r?.config?.aiMessagesConfig?.CHATGPT||{},L=document.head.querySelector("script[bis_use][id]")?.getAttribute("id")||"",{PARSERS:Q=[],CHATBOT_NAME:M="",AI_FEATURES:A}=x;D();const T=k=>{try{let E={posdMessageId:"PANELOS_MESSAGE",posdHash:(Math.random().toString(36).substring(2,15)+Math.random().toString(36).substring(2,15)+Math.random().toString(36).substring(2,15)).substring(0,22),type:"CHATGPT_DATA",from:n,to:n.substring(0,n.length-2),appId:L,content:k};window.postMessage(E)}catch(k){}},s=function(k,E,D){if(!E?.length)return null;try{if(m(k,E,D.RULES_GET_SYSTEM_VALUES),!k?.messageText)return null;k.messageType="system",k.creationTime=null,B(k,D.MESSAGE_LIMIT||3e4)}catch(k){}},O=function(k,E,D,r){try{if(m(k,E,r.RULES_GET_USER_VALUES),!k?.messageText)return null;B(k,r.MESSAGE_LIMIT||1e4),k.messageType="user",k.creationTime=D}catch(k){}},m=function(k,E,D){for(let r of D)r.PATH?.length?"payload"===r.SOURCE?k[r.NAME]=f.byPath(E,r.PATH):k[r.NAME]=f.byPath(null,r.PATH):r.REDUCE_PARAMS&&(k[r.NAME]=f.byReduce(E,r.REDUCE_PARAMS))},B=function(k,E){let D=k.messageText;"object"==typeof D&&D?.length&&(D=D.reduce(((k,E)=>"object"==typeof E?k:`${k} ${E}`),"")),k.messageText=D.trim().slice(0,E),k.messageLength=k.messageText.length},X=function(k,E,D){return new RegExp(D.REGEXP_URL_CHECK).test(k)&&E===D.REQUEST_METHOD},h=function(k,D,r,n,x){let L={chatbotName:M,messages:[]},Q={},A={};if(k?.body?.length){let D=JSON.parse(k.body);m(L,D,x.GENERAL_DATA.GET_BY_PATH),E||O(Q,D,r,x.SENT_MESSAGE)}s(A,n,x.RECEIVED_MESSAGE),Q?.messageText&&L.messages.push(Q),A?.messageText&&L.messages.push(A),L.sessionId||(L.sessionId=D),L.messages.length&&setTimeout((()=>T(L)),0)},y=async function(k,E,D,r){const n=E.body.getReader(),x=new TextDecoder("utf-8");let L="",Q=[],M="";try{for(;;){const{done:k,value:E}=await n.read();if(k)break;L+=x.decode(E,{stream:!0});let D=L.split("\n");for(let k=0;k<D.length;k++){const E=D[k].trim();if(E.startsWith("data:")&&r.RECEIVED_MESSAGE.INVALID_VALUES_TO_PARSE.some((k=>!E.includes(k)))){const k=E.slice(5).trim();try{Q.push(JSON.parse(k))}catch(k){}}}M||(M=L.match(new RegExp(r.REGEXP_SESSION_ID_FROM_STREAM))?.groups?.sessionId),L=D[D.length-1]}}catch(k){}finally{h(k,M,D,Q,r)}},Y=function(k,E,D){return new Promise((r=>{if(!k?.body?.length)return void r(!0);let n,x=A?.DATA_PROTECTION?.MAX_DELAY_TIMEOUT||3e3,L=setTimeout((()=>{window.removeEventListener("message",n),r(!0)}),x),Q={chatbotName:M,messages:[],startDelayTime:(new Date).getTime(),maxDelayTime:x},s={};try{let x=JSON.parse(k.body);m(Q,x,D.GENERAL_DATA.GET_BY_PATH),O(s,x,E,D.SENT_MESSAGE),s?.messageText&&Q.messages.push(s),n=function(k){switch(k.data?.type){case"AI_FEATURES_PROTECTION_CHECK_RESPONSE":case"AI_FEATURES_PROTECTION_NO_WARNINGS":clearTimeout(L),window.removeEventListener("message",n),r(k.data.result);break;case"AI_FEATURES_PROTECTION_CLEAR_TIMEOUT":clearTimeout(L)}}.bind(this),window.addEventListener("message",n),T(Q)}catch(k){clearTimeout(L),r(!0)}}))},J={XMLHttpRequest:function(k){const D=self.fetch;self.fetch=async function(r,n={}){const x="string"==typeof r?r:r.url,L=n.method||"GET",Q=new Date,M=X(x,L,k);let T;try{if(T=!M||!E||await Y(n,Q,k),!T)throw new Error(A?.DATA_PROTECTION?.MESSAGE_ABORTED_REQUEST||"");const r=await D.apply(this,arguments),x=r.clone();return r.ok&&r.body instanceof ReadableStream&&M&&setTimeout(y.bind(this,n,x,Q,k),0),r}catch(k){return T?D.apply(this,arguments):new Promise(((E,D)=>{D(k.message)}))}}}},f={byReduce:(k,E)=>{const{KEY:D,TYPE:r,RED_FLAG_PATH:n,RED_FLAG_VALUE:x,PATHS_GET_TEXT:L,INVALID_TEXT_VALUES:Q,FINISH_VALUE:M,ROLE_CHECK:A,CHECK_STREAM_COMPLETE:T,PARAMS_FOR_CITATION_URLS:s,CHECK_PARAMS:O}=E;if(n?.length)for(let E of k){if(f.byPath(E,n)===x)return null}const m=[],B=new RegExp(s.CITATION_MARKERS_REGEXP,"g");let X=k.reduce(((k,E,n,x)=>{if(!E.hasOwnProperty(D))return k;let s=JSON.stringify(E);if(s.includes(A))return k;if(s.includes(T))return x.splice(n),k;if(typeof E[D]===r&&E[D]!==M)return k+=E[D];if(!Array.isArray(E[D]))for(let n of L){let x=f.byPath(E[D],n);x&&!Q.includes(x)&&(k+=typeof x===r&&x!==M?x:x?.join(""))}if(Array.isArray(E[D]))for(let n of O){const{VALIDATION_KEY:x,REGEXP_VALUE:L,PART_OF:Q}=n,A=new RegExp(L);for(let n of E[D]){A.test(n[x])&&("text"===Q&&n[D]&&typeof n[D]===r&&n[D]!==M?k+=n[D]:"citation_url"===Q&&m.push({path:n[x],value:n[D]}))}}return k}),""),h=m.reduce(((k,E)=>{let D=!1;"string"==typeof E.value&&(E.value=[E.value]);for(let r of k){if(!r)continue;const k=r.path.match(new RegExp(s.CITATION_PATH_CORE_REGEXP))?.groups.pathCore;if(E.path.includes(k)&&(D=!0,Array.isArray(E.value))){r.value=r.value.concat(E.value);let k=[];r.value=r.value.filter((E=>!k.includes(E)&&(k.push(E),!0)))}}return D||k.push(E),k}),[]).map((k=>k.value.filter((k=>!new RegExp(s.REGEXP_URL_IMAGES_FILTER,"i").test(k))))).filter((k=>k.length)),y=X.match(B);if(y?.length){const k=!!h?.length;for(let E=0;E<y.length;E++){let D=y[E],r=h[E];const n=k?`${s.CITATION_URLS_WRAP_SYMBOLS[0]}${r.join(s.CITATION_URLS_SEPARATE_SYMBOL)}${s.CITATION_URLS_WRAP_SYMBOLS[1]}`:"";X=X.replace(D,n)}}return X},byPath:(k,E)=>{let D=k||self;for(let k=0;k<E.length;k++){const r=E[k];if(!D.hasOwnProperty(r)){D=null;break}D=D[r]}return D}};(function(){for(let k of Q)k.USE&&J[k.TYPE](k)})()}catch(k){}})()})();