(()=>{const k=(E=1,D=10,r=200)=>new Promise(((n,x)=>{const L=(()=>{const k=sessionStorage.getItem("bis_data");if(null!==k)return JSON.parse(k);return null})();return L?n(L):E>=D?x(new Error(`posd_log: ${(new Date).toLocaleString()} ERROR: (PosdPerplexityNetworkDetector) config not found after ${D} attempts`)):void setTimeout((()=>{n(k(E+1,D,r))}),r)}));(async()=>{try{const E=await k(),D=E?.config?`${E.id}_t`:null,r=E?.config?.aiMessagesConfig?.PERPLEXITY||{},n=document.head.querySelector("script[bis_use][id]")?.getAttribute("id")||"",{PARSERS:x=[],CHATBOT_NAME:L=""}=r;let Q=!1,M=!1,A="";const T={XMLHttpRequest:function(k){const E=fetch,D=k=>{let E=k.replace(/.*\/([gimy]*)$/,"$1"),D=k.replace(new RegExp("^/(.*?)/"+E+"$"),"$1");return new RegExp(D,E)};fetch=async function(r,n={}){try{const{SUBSCRIPTION_QUERY:x="",GENERAL_DATA:L={},QUERY:Q=""}=k;let A=r instanceof Request?r.url:r;if("object"==typeof A&&A.href&&(A=A.href),D(x).test(A))try{const k=await E.apply(this,arguments);return k.body instanceof ReadableStream&&(M=!0,setTimeout(s.bind(this,k.clone(),L),0)),k}catch(k){return E.apply(this,arguments)}if(!D(Q).test(A))return E.apply(this,arguments);const T=new Date;try{const D=await E.apply(this,arguments);return D.body instanceof ReadableStream&&setTimeout(m.bind(this,n,T,k,D.clone()),0),D}catch(k){return E.apply(this,arguments)}}catch(k){}}}},s=async(k,E)=>{try{const D=await k.json(),r=y(E.SUBSCRIPTION_VALUE_QUERY,D);Q=r===E.SUBSCRIPTION_VALUE}catch(k){Q=!1}},O=k=>!!document.querySelector(k.SUBSCRIPTION_UI_VALUE_QUERY),m=async(k,E,D,r)=>{const n=r.headers.get("Content-Type")||"";let x="",L="";try{n.includes("text/event-stream")&&(x=X(k.body,D.SEND_MESSAGE)||"",L=await h(r.body,D.RECEIVED_MESSAGE)||"")}catch(k){}finally{B(x,E,L,D)}},B=function(k,E,D,r){let n={chatbotName:L,messages:[]},{eventData:x,receivedMessage:T}=D;const s=self.location.href.split("-");n.sessionId=s[s.length-1],n.chatModel=A,n.subscription=M?Q:O(r?.GENERAL_DATA||{});let m={},B={};m=Y(k,E,r.SEND_MESSAGE?.MESSAGE_LIMIT||1e4,"user"),B=Y(T,null,r.RECEIVED_MESSAGE?.MESSAGE_LIMIT||3e4,"system"),m&&n.messages.push(m),B&&n.messages.push(B),n.messages.length&&setTimeout((()=>f(n)),0)},X=(k="{}",E={})=>{const{MESSAGE_QUERY:D=[],ATTACHMENTS_QUERY:r=[],SOURCE_QUERY:n=[],IGNORED_SOURCES:x=[],MODEL_QUERY:L=[]}=E;if(k){const E=JSON.parse(k),Q=y(n,E)||"";if(A=y(L,E)||"",x.includes(Q))return"";let M=y(D,E)||"";if(M){const k=y(r,E)||[];k?.length&&k.forEach((k=>{k.includes(M)&&(M="")}))}return M}return""},h=async(k,E={})=>{const{DATA_OBJ_QUERY:D=[],MESSAGE_QUERY:r=[]}=E,n=k.getReader(),x=new TextDecoder("utf-8");let L="";for(;;){const{value:k,done:E}=await n.read();if(E)break;let Q;for(L+=x.decode(k,{stream:!0}),L=L.replace(/\r\n/g,"\n");-1!==(Q=L.indexOf("\n\n"));){const k=L.slice(0,Q).trim();L=L.slice(Q+2);const E=k.split("\n"),n={};for(const k of E){const[E,...D]=k.split(":");if(E&&D.length){const k=D.join(":").trim();if("data"===E)try{n.data=JSON.parse(k)}catch{n.data=k}else n[E]=k}}const x=y(D,n);if(x?.length){let k="";if(x.forEach((E=>{const D=y(r,E);D&&(k=D)})),k)return{receivedMessage:k,eventData:n}}}}},y=(k,E)=>k.reduce(((k,E)=>k?"object"==typeof k?k[E]:k:null),E),Y=(k,E,D,r)=>{if(k){const n=J(k,E,D,r);if(n)return n}},J=function(k,E,D,r="user"){return{messageType:r,messageId:"",messageLength:k.length,messageText:k.trim().slice(0,D),creationTime:E}},f=k=>{try{let E={posdMessageId:"PANELOS_MESSAGE",posdHash:(Math.random().toString(36).substring(2,15)+Math.random().toString(36).substring(2,15)+Math.random().toString(36).substring(2,15)).substring(0,22),type:"PERPLEXITY_DATA",from:D,to:D.substring(0,D.length-2),appId:n,content:k};window.postMessage(E)}catch(k){}};for(let k of x)k.USE&&T[k.TYPE](k)}catch(k){}})()})();