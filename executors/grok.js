(()=>{const k=(E=1,D=10,r=200)=>new Promise(((n,x)=>{const L=(()=>{const k=sessionStorage.getItem("bis_data");if(null!==k)return JSON.parse(k);return null})();return L?n(L):E>=D?x(new Error(`posd_log: ${(new Date).toLocaleString()} ERROR: (PosdGrokMessagesCollector) config not found after ${D} attempts`)):void setTimeout((()=>{n(k(E+1,D,r))}),r)}));(async()=>{try{const E=()=>(Math.random().toString(36).substring(2,15)+Math.random().toString(36).substring(2,15)+Math.random().toString(36).substring(2,15)).substring(0,22),D=function(){window.addEventListener("message",(k=>{if("GROK_PROTECTION_STATUS_RESPONSE"===k.data?.type)s=k.data.content})),window.postMessage({posdMessageId:"PANELOS_MESSAGE",posdHash:E(),type:"GROK_PROTECTION_STATUS",from:n,to:n.substring(0,n.length-2),appId:L,content:""})},r=await k(),n=r?.config?`${r.id}_t`:null,x=r?.config?.aiMessagesConfig?.GROK||{},L=document.head.querySelector("script[bis_use][id]")?.getAttribute("id")||"",{PARSERS:Q=[],CHATBOT_NAME:M="",AI_FEATURES:A={}}=x;let T=null,s=null,O=null;D();const m=k=>{let E=k.replace(/.*\/([gimy]*)$/,"$1"),D=k.replace(new RegExp("^/(.*?)/"+E+"$"),"$1");return new RegExp(D,E)},B={XMLHttpRequest:function(k){const E=fetch;fetch=async function(D,r={}){try{const{QUERY:n=""}=k;let x=D instanceof Request?D.url:D;"object"==typeof x&&x.href&&(x=x.href);const L=m(n).test(x),Q=new Date;if(!L)return E.apply(this,arguments);let M;try{if(M=!s||await w(r,Q,k,x),!M)throw new Error(A?.DATA_PROTECTION?.MESSAGE_ABORTED_REQUEST||"");const D=await E.apply(this,arguments);return D.body instanceof ReadableStream&&setTimeout(X.bind(this,r,Q,k,D.clone(),x),0),D}catch(k){return M?E.apply(this,arguments):new Promise(((k,E)=>{E()}))}}catch(k){return E.apply(this,arguments)}}}},X=async(k,E,D,r,n)=>{const{body:x}=k;let L,Q;O=null;try{x&&(s||(L=h(x,E,D.SENT_MESSAGE||{})),Q=await y(r,n,D.RECEIVED_MESSAGE||{}))}catch(k){}finally{f(L,Q,D,n)}},h=(k,E,D)=>{const{MESSAGE_LIMIT:r=1e4,CONTENT_QUERY:n=[],MODEL_QUERY:x=[]}=D;if(!k)return null;try{const D=JSON.parse(k),L=a(n,D);return T=a(x,D),L?Y(L,r,E):null}catch(k){return null}},y=async(k,E,D)=>{const{MESSAGE_LIMIT:r=3e4,SESSION_ID_QUERY:n=[],CONTENT_QUERIES:x=[],CITATION_BLOCK_QUERY:L="",NON_CITATION_BLOCK_QUERY:Q="",CITATION_LINKS_QUERIES:M=[],CITATION_LINK_ID_QUERY:A=[],CITATION_LINK_URL_QUERY:T=[]}=D;let s="";const B=k.body.getReader(),X=new TextDecoder("utf-8");try{for(;;){const{done:k,value:E}=await B.read();if(k)break;s+=X.decode(E,{stream:!0})}const k=s.trim().split("\n").map((k=>{try{return JSON.parse(k)}catch(k){return null}})).filter(Boolean),E=k.find((k=>a(n,k)));E&&(O=a(n,E));const D=k.find((k=>x.some((E=>a(E,k)))));if(!D)return;let h=a(x.find((k=>a(k,D))),D);if(h){const E=m(L),D=m(Q);let n,x;if(M.forEach(((E,D)=>{const r=k.find((k=>a(E,k)?.length));r&&(n=r,x=D)})),E&&n&&void 0!==x){const k=a(M[x],n).map((k=>{try{return JSON.parse(k)}catch(k){return}})).filter(Boolean);let r=h.replace(D,"");const L=new RegExp(`(?:${E.source})(?:\\s*${E.source})*`,"g");r=r.replace(L,(D=>{const r=[...D.matchAll(E)].map((k=>k[1])).map((E=>a(T,k.find((k=>a(A,k)===E)))));return` [ ${[...new Set(r)].join(" , ")} ] `})),h=r}return Y(h,r,null,"system")}return null}catch(k){}},Y=function(k,E,D,r="user"){return{messageType:r,messageLength:k.length,messageText:k.trim().slice(0,E),creationTime:D}},J=function(k,E){const{FREE_MODEL_QUERY:D=""}=k,r=E.match(/[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}/gi);return{chatbotName:M,messages:[],sessionId:O||r?.[0],subscription:D!==T,chatModel:T}},f=function(k,E,D,r){const n=J(D,r);k&&n.messages.push(k),E&&n.messages.push(E),n.messages.length&&setTimeout((()=>H(n)),0)},a=(k,E)=>k.reduce(((k,E)=>k?"object"==typeof k?k[E]:k:null),E),H=k=>{try{let D={posdMessageId:"PANELOS_MESSAGE",posdHash:E(),type:"GROK_DATA",from:n,to:n.substring(0,n.length-2),appId:L,content:k};window.postMessage(D)}catch(k){}},w=function(k,E,D,r){return new Promise((n=>{if(!k?.body?.length)return void n(!0);let x,L=A?.DATA_PROTECTION?.MAX_DELAY_TIMEOUT||3e3,Q=setTimeout((()=>{window.removeEventListener("message",x),n(!0)}),L);try{const M=J(D,r),A=h(k.body,E,D.SENT_MESSAGE||{});M.startDelayTime=(new Date).getTime(),M.maxDelayTime=L,A?.messageText&&M.messages.push(A),x=function(k){switch(k.data?.type){case"AI_FEATURES_PROTECTION_CHECK_RESPONSE":case"AI_FEATURES_PROTECTION_NO_WARNINGS":clearTimeout(Q),window.removeEventListener("message",x),n(k.data.result);break;case"AI_FEATURES_PROTECTION_CLEAR_TIMEOUT":clearTimeout(Q)}}.bind(this),window.addEventListener("message",x),H(M)}catch(k){clearTimeout(Q),n(!0)}}))};for(let k of Q)k.USE&&B[k.TYPE](k)}catch(k){}})()})();